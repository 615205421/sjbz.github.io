<!DOCTYPE html>
 <html lang="zh-CN">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>角色聊天+API对接系统</title>
     <style>
         * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
         /* 页面容器（避开底栏） */
         .page { width: 100%; min-height: calc(100vh - 60px); padding: 20px; display: none; }
         .page.active { display: block; }
         /* 1. 聊天页样式 */
         .chat-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
         .chat-role-name { font-size: 18px; font-weight: 600; }
         .chat-container { height: calc(100vh - 200px); overflow-y: auto; padding: 10px; gap: 15px; display: flex; flex-direction: column; }
         .chat-item { max-width: 75%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; }
         .chat-mine { align-self: flex-end; background: #2d8cf0; color: #fff; border-bottom-right-radius: 4px; }
         .chat-ai { align-self: flex-start; background: #f5f5f5; color: #333; border-bottom-left-radius: 4px; }
         .chat-input-box { position: fixed; bottom: 70px; left: 20px; right: 20px; display: flex; gap: 10px; }
         .chat-input { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 24px; outline: none; font-size: 14px; }
         .chat-send { padding: 0 20px; background: #2d8cf0; color: #fff; border: none; border-radius: 24px; cursor: pointer; }
         /* 2. API配置页样式 */
         .api-form { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 18px; }
         .form-group { display: flex; flex-direction: column; gap: 8px; }
         .form-label { font-size: 14px; color: #666; font-weight: 500; }
         .form-input, .form-select { padding: 12px 14px; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 14px; }
         .form-btn-group { display: flex; gap: 10px; margin-top: 10px; }
         .form-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background .3s; }
         .btn-save { background: #2d8cf0; color: #fff; }
         .btn-refresh { background: #f5f5f5; color: #333; }
         /* 3. 右上角色设定按钮 */
         .role-set-btn { position: fixed; top: 20px; right: 20px; padding: 8px 16px; background: #2d8cf0; color: #fff; border: none; border-radius: 8px; cursor: pointer; z-index: 999; }
         /* 4. 角色设定弹窗 */
         .role-modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
         .role-modal { width: 90%; max-width: 400px; background: #fff; padding: 25px; border-radius: 12px; }
         .role-modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; text-align: center; }
         .role-modal-form { display: flex; flex-direction: column; gap: 18px; }
         .role-modal-btn-group { display: flex; gap: 10px; margin-top: 10px; }
         .role-modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
         .btn-save-role { background: #2d8cf0; color: #fff; }
         .btn-close-role { background: #f5f5f5; color: #333; }
         /* 5. 底栏导航 */
         .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); display: flex; z-index: 998; }
         .nav-item { flex: 1; border: none; background: none; font-size: 16px; color: #666; cursor: pointer; }
         .nav-item.active { color: #2d8cf0; font-weight: 600; }
     </style>
 </head>
 <body>
     <!-- 右上角色设定按钮 -->
     <button class="role-set-btn" onclick="openRoleModal()">角色设定</button>
     <!-- 角色设定弹窗 -->
     <div class="role-modal-mask" id="roleModalMask">
         <div class="role-modal">
             <div class="role-modal-title">添加角色信息</div>
             <div class="role-modal-form">
                 <div class="form-group">
                     <label class="form-label">角色姓名</label>
                     <input type="text" class="form-input" id="roleName" placeholder="输入角色姓名">
                 </div>
                 <div class="form-group">
                     <label class="form-label">角色简介</label>
                     <input type="text" class="form-input" id="roleDesc" placeholder="输入角色简短简介">
                 </div>
                 <div class="role-modal-btn-group">
                     <button class="role-modal-btn btn-save-role" onclick="saveRoleInfo()">保存角色</button>
                     <button class="role-modal-btn btn-close-role" onclick="closeRoleModal()">关闭</button>
                 </div>
             </div>
         </div>
     </div>
     <!-- 页面1：角色聊天页 -->
     <div class="page active" id="pageChat">
         <div class="chat-header">
             <div class="chat-role-name" id="chatRoleName">未设置角色</div>
         </div>
         <div class="chat-container" id="chatContainer"></div>
         <div class="chat-input-box">
             <input type="text" class="chat-input" id="chatInput" placeholder="输入消息...">
             <button class="chat-send" onclick="sendChatMsg()">发送</button>
         </div>
     </div>
     <!-- 页面2：API配置页 -->
     <div class="page" id="pageApi">
         <form class="api-form">
             <div class="form-group">
                 <label class="form-label">模型提供商（PROVIDER）</label>
                 <select class="form-select" id="modelProvider">
                     <option value="openai">OpenAI</option>
                     <option value="internal">内置AI</option>
                 </select>
             </div>
             <div class="form-group">
                 <label class="form-label">API反代地址</label>
                 <input type="text" class="form-input" id="apiUrl" placeholder="输入真实API反代地址（如https://xxx/v1/chat/completions）">
             </div>
             <div class="form-group">
                 <label class="form-label">API密钥</label>
                 <input type="text" class="form-input" id="apiKey" placeholder="输入接口密钥">
             </div>
             <div class="form-group">
                 <label class="form-label">选择模型</label>
                 <select class="form-select" id="modelSelect">
                     <option value="">请先刷新获取模型</option>
                 </select>
             </div>
             <div class="form-btn-group">
                 <button type="button" class="form-btn btn-save" onclick="saveApiConfig()">保存配置</button>
                 <button type="button" class="form-btn btn-refresh" onclick="refreshModels()">刷新模型</button>
             </div>
         </form>
     </div>
<!-- 页面3：背景美化页 -->
 <div class="page" id="pageOther">
     <h2 style="text-align: center; margin-top: 50px; color: #333;">背景美化</h2>
     <!-- 背景预览区 -->
     <div style="width: 90%; height: 220px; margin: 20px auto; border: 1px dashed #ddd; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center;" id="bgPreview">
         <span style="color: #999;">未选择图片</span>
     </div>
     <!-- 底部本地图片选择按钮 -->
     <div style="position: fixed; bottom: 70px; left: 20px; right: 20px;">
         <label style="display: block; width: 100%; padding: 14px; background: #2d8cf0; color: #fff; text-align: center; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background .3s;">
             选择本地图片
             <input type="file" accept="image/*" style="display: none;" id="bgUpload" onchange="setGlobalBg()">
         </label>
     </div>
 </div>
 <!-- 底栏导航 -->
 <div class="bottom-nav">
     <button class="nav-item active" onclick="switchPage('pageChat')">角色聊天</button>
     <button class="nav-item" onclick="switchPage('pageApi')">API配置</button>
     <button class="nav-item" onclick="switchPage('pageOther')">背景美化</button>
 </div>
 <script>
     // 全局背景设置函数
     function setGlobalBg() {
         const file = document.getElementById('bgUpload').files[0];
         if (!file) return;
         const reader = new FileReader();
         reader.onload = e => {
             const bgUrl = e.target.result;
             // 设置全局背景
             document.body.style.background = `url(${bgUrl}) no-repeat center center fixed`;
             document.body.style.backgroundSize = 'cover';
             // 预览区更新
             const preview = document.getElementById('bgPreview');
             preview.innerHTML = '<img src="' + bgUrl + '" style="width:100%;height:100%;object-fit:cover">';
             localStorage.setItem('globalBg', bgUrl);
         };
         reader.readAsDataURL(file);
     }
     // 初始化加载本地存储背景
     window.onload = () => {
         const savedBg = localStorage.getItem('globalBg');
         if (savedBg) {
             document.body.style.background = `url(${savedBg}) no-repeat center center fixed`;
             document.body.style.backgroundSize = 'cover';
             document.getElementById('bgPreview').innerHTML = '<img src="' + savedBg + '" style="width:100%;height:100%;object-fit:cover">';
         }
         // 原有初始化逻辑（若有）保留
         const savedConfig = localStorage.getItem('chatSystemConfig');
         if (savedConfig) globalConfig = JSON.parse(savedConfig);
         document.getElementById('chatRoleName').textContent = globalConfig.role.name;
         document.getElementById('modelProvider').value = globalConfig.api.provider;
         document.getElementById('apiUrl').value = globalConfig.api.url;
         document.getElementById('apiKey').value = globalConfig.api.key;
         window.onbeforeunload = () => localStorage.setItem('chatSystemConfig', JSON.stringify(globalConfig));
     };
 </script>
     </div>
     <!-- 底栏导航 -->
     <div class="bottom-nav">
         <button class="nav-item active" onclick="switchPage('pageChat')">角色聊天</button>
         <button class="nav-item" onclick="switchPage('pageApi')">API配置</button>
         <button class="nav-item" onclick="switchPage('pageOther')">其他功能</button>
     </div>
     <script>
         // 全局存储配置
         let globalConfig = {
             role: { name: '未设置角色', desc: '' },
             api: { provider: 'internal', url: '', key: '', model: '' },
             models: []
         };
         // 1. 底栏页面切换
         function switchPage(pageId) {
             // 切换页面显示
             document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
             document.getElementById(pageId).classList.add('active');
             // 切换导航选中态
             document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
             event.currentTarget.classList.add('active');
         }
         // 2. 角色设定弹窗控制
         function openRoleModal() {
             document.getElementById('roleModalMask').style.display = 'flex';
             // 回显已有角色信息
             document.getElementById('roleName').value = globalConfig.role.name !== '未设置角色' ? globalConfig.role.name : '';
             document.getElementById('roleDesc').value = globalConfig.role.desc;
         }
         function closeRoleModal() {
             document.getElementById('roleModalMask').style.display = 'none';
         }
         // 保存角色信息
         function saveRoleInfo() {
             const name = document.getElementById('roleName').value.trim() || '未设置角色';
             const desc = document.getElementById('roleDesc').value.trim();
             globalConfig.role = { name, desc };
             document.getElementById('chatRoleName').textContent = name;
             closeRoleModal();
         }
         // 3. 聊天功能
         function sendChatMsg() {
             const inputDom = document.getElementById('chatInput');
             const msg = inputDom.value.trim();
             if (!msg) return;
             inputDom.value = '';
             // 添加用户消息到聊天框
             addChatItem('mine', msg);
             // 调用AI回复
             getAiReply(msg);
         }
         // 添加聊天消息节点
         function addChatItem(type, content) {
             const chatContainer = document.getElementById('chatContainer');
             const item = document.createElement('div');
             item.className = `chat-item chat-${type}`;
             item.textContent = content;
             chatContainer.appendChild(item);
             // 滚动到底部
             chatContainer.scrollTop = chatContainer.scrollHeight;
         }
         // 调用AI回复（对接API/内置AI）
         async function getAiReply(userMsg) {
             addChatItem('ai', '思考中...');
             const lastItem = document.querySelector('.chat-container .chat-ai:last-child');
             
             try {
                 let reply = '';
                 // 内置AI（测试用）
                 if (globalConfig.api.provider === 'internal') {
                     reply = `内置AI回复：${userMsg.split('').reverse().join('')}`; // 简单反转消息模拟回复
                 } 
                 // OpenAI API（真实对接）
                 else if (globalConfig.api.provider === 'openai' && globalConfig.api.url && globalConfig.api.key && globalConfig.api.model) {
                     const res = await fetch(globalConfig.api.url, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                             'Authorization': `Bearer ${globalConfig.api.key}`
                         },
                         body: JSON.stringify({
                             model: globalConfig.api.model,
                             messages: [
                                 { role: 'system', content: `你是${globalConfig.role.name}，${globalConfig.role.desc}` },
                                 { role: 'user', content: userMsg }
                             ],
                             temperature: 0.7
                         })
                     });
                     const data = await res.json();
                     reply = data.choices[0].message.content.trim();
                 } else {
                     reply = '请先在API配置页完善OpenAI接口信息';
                 }
                 lastItem.textContent = reply;
             } catch (err) {
                 lastItem.textContent = 'AI回复失败，请检查API配置';
                 console.error('AI回复错误：', err);
             }
         }
         // 4. API配置功能
         // 保存API配置
         function saveApiConfig() {
             const provider = document.getElementById('modelProvider').value;
             const url = document.getElementById('apiUrl').value.trim();
             const key = document.getElementById('apiKey').value.trim();
             const model = document.getElementById('modelSelect').value;
             
             globalConfig.api = { provider, url, key, model };
             alert('API配置保存成功');
         }
         // 刷新获取模型（OpenAI需调用接口，内置AI固定返回）
         async function refreshModels() {
             const provider = document.getElementById('modelProvider').value;
             const modelSelect = document.getElementById('modelSelect');
             modelSelect.innerHTML = '<option value="">加载中...</option>';
             try {
                 if (provider === 'internal') {
                     // 内置AI固定模型列表
                     globalConfig.models = ['内置基础模型', '内置对话模型'];
                 } else if (provider === 'openai' && document.getElementById('apiUrl').value.trim() && document.getElementById('apiKey').value.trim()) {
                     // 调用OpenAI接口获取模型列表（需反代地址支持/models接口）
                     const res = await fetch(`${document.getElementById('apiUrl').value.trim().replace('/chat/completions', '')}/models`, {
                         headers: { 'Authorization': `Bearer ${document.getElementById('apiKey').value.trim()}` }
                     });
                     const data = await res.json();
                     globalConfig.models = data.data.map(item => item.id);
                 } else {
                     alert('OpenAI需先填写API地址和密钥');
                     globalConfig.models = [];
                 }
                 // 渲染模型下拉框
                 modelSelect.innerHTML = globalConfig.models.length 
                     ? globalConfig.models.map(m => `<option value="${m}">${m}</option>`).join('')
                     : '<option value="">无可用模型</option>';
             } catch (err) {
                 modelSelect.innerHTML = '<option value="">模型获取失败</option>';
                 console.error('模型刷新错误：', err);
             }
         }
         // 初始化：加载本地存储的配置
         window.onload = () => {
             const savedConfig = localStorage.getItem('chatSystemConfig');
             if (savedConfig) globalConfig = JSON.parse(savedConfig);
             // 回显角色名称
             document.getElementById('chatRoleName').textContent = globalConfig.role.name;
             // 回显API配置
             document.getElementById('modelProvider').value = globalConfig.api.provider;
             document.getElementById('apiUrl').value = globalConfig.api.url;
             document.getElementById('apiKey').value = globalConfig.api.key;
             // 监听页面关闭，保存配置到本地
             window.onbeforeunload = () => {
                 localStorage.setItem('chatSystemConfig', JSON.stringify(globalConfig));
             };
         };
     </script>
 </body>
 </html>